#include <avr/io.h>
#include <avr/interrupt.h>

#define FOSC   16000000U
#define BAUD   9600
#define MYUBRR (FOSC/16/BAUD - 1)

char msg_rx[2];
int pos_msg_rx = 0;
int tamanho_msg_rx = 1;

#define LED_VERDE   (1<<PB1)
#define LED_VERMELHO (1<<PB0)

void UART_Init(unsigned int ubrr);
void UART_Transmit(char *dados);

ISR(USART_RX_vect)
{
    msg_rx[pos_msg_rx++] = UDR0;
    if (pos_msg_rx == tamanho_msg_rx)
        pos_msg_rx = 0;
}

void UART_Init(unsigned int ubrr)
{
    UBRR0H = (unsigned char)(ubrr >> 8);
    UBRR0L = (unsigned char)ubrr;
    UCSR0B = (1<<RXEN0)|(1<<TXEN0)|(1<<RXCIE0);
    UCSR0C = (1<<UCSZ01)|(1<<UCSZ00);
}

void UART_Transmit(char *dados)
{
    while (*dados != 0)
    {
        while (!(UCSR0A & (1<<UDRE0)));
        UDR0 = *dados;
        dados++;
    }
}

int main(void)
{
    UART_Init(MYUBRR);
    sei();

    DDRB |= LED_VERDE | LED_VERMELHO;

    UART_Transmit("Envie 8 (verde) ou 9 (vermelho)\n");

    while (1)
    {
        if (msg_rx[0] == '9')
        {
            PORTB |= LED_VERMELHO;
            PORTB &= ~LED_VERDE;
            UART_Transmit("Vermelho ON\n");
        }
        else if (msg_rx[0] == '8')
        {
            PORTB |= LED_VERDE;
            PORTB &= ~LED_VERMELHO;
            UART_Transmit("Verde ON\n");
        }
    }
}
